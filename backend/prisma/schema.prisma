// Schema de Prisma para sistema de campeonatos de fútbol

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// MODELO DE USUARIOS
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  firstName String   @map("first_name")
  lastName  String   @map("last_name")
  phone     String?
  role      UserRole @default(USER)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  championshipsCreated Championship[] @relation("ChampionshipCreator")
  teamsManaged         Team[]         @relation("TeamManager")

  @@map("users")
}

enum UserRole {
  ADMIN
  ORGANIZER
  USER
}

// MODELO DE CAMPEONATOS
model Championship {
  id          String           @id @default(uuid())
  name        String
  description String?
  location    String
  startDate   DateTime         @map("start_date")
  endDate     DateTime?        @map("end_date")
  category    String
  rules       String?
  status      ChampionshipStatus @default(UPCOMING)

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relaciones
  creatorId String @map("creator_id")
  creator   User   @relation("ChampionshipCreator", fields: [creatorId], references: [id])

  teams     TeamChampionship[]
  matches   Match[]
  standings Standing[]

  @@index([status, startDate])
  @@map("championships")
}

enum ChampionshipStatus {
  UPCOMING
  ACTIVE
  FINISHED
  CANCELLED
}

// MODELO DE EQUIPOS
model Team {
  id           String   @id @default(uuid())
  name         String
  logo         String?
  category     String
  representative String?
  phone        String?
  email        String?

  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relaciones
  managerId String? @map("manager_id")
  manager   User?   @relation("TeamManager", fields: [managerId], references: [id])

  players       Player[]
  championships TeamChampionship[]
  homeMatches   Match[]            @relation("HomeTeam")
  awayMatches   Match[]            @relation("AwayTeam")
  standings     Standing[]

  @@map("teams")
}

// TABLA INTERMEDIA EQUIPOS-CAMPEONATOS
model TeamChampionship {
  championshipId String       @map("championship_id")
  teamId         String       @map("team_id")

  championship   Championship @relation(fields: [championshipId], references: [id], onDelete: Cascade)
  team           Team         @relation(fields: [teamId], references: [id], onDelete: Cascade)

  registeredAt   DateTime     @default(now()) @map("registered_at")

  @@id([championshipId, teamId])
  @@map("team_championships")
}

// MODELO DE JUGADORES
model Player {
  id           String   @id @default(uuid())
  firstName    String   @map("first_name")
  lastName     String   @map("last_name")
  jerseyNumber Int      @map("jersey_number")
  position     Position
  dateOfBirth  DateTime? @map("date_of_birth")
  photo        String?

  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relaciones
  teamId String @map("team_id")
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  events MatchEvent[]

  @@unique([teamId, jerseyNumber])
  @@index([teamId])
  @@map("players")
}

enum Position {
  PORTERO
  DEFENSA
  MEDIOCAMPISTA
  DELANTERO
}

// MODELO DE PARTIDOS
model Match {
  id           String      @id @default(uuid())
  matchDate    DateTime    @map("match_date")
  location     String
  field        String?
  status       MatchStatus @default(SCHEDULED)
  homeScore    Int         @default(0) @map("home_score")
  awayScore    Int         @default(0) @map("away_score")

  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relaciones
  championshipId String       @map("championship_id")
  championship   Championship @relation(fields: [championshipId], references: [id], onDelete: Cascade)

  homeTeamId String @map("home_team_id")
  homeTeam   Team   @relation("HomeTeam", fields: [homeTeamId], references: [id])

  awayTeamId String @map("away_team_id")
  awayTeam   Team   @relation("AwayTeam", fields: [awayTeamId], references: [id])

  events MatchEvent[]

  @@index([championshipId, matchDate])
  @@index([status])
  @@map("matches")
}

enum MatchStatus {
  SCHEDULED
  LIVE
  FIRST_HALF
  HALF_TIME
  SECOND_HALF
  FINISHED
  SUSPENDED
  CANCELLED
}

// MODELO DE EVENTOS DE PARTIDO
model MatchEvent {
  id          String    @id @default(uuid())
  eventType   EventType @map("event_type")
  minute      Int
  description String?

  createdAt   DateTime  @default(now()) @map("created_at")

  // Relaciones
  matchId String @map("match_id")
  match   Match  @relation(fields: [matchId], references: [id], onDelete: Cascade)

  playerId String? @map("player_id")
  player   Player? @relation(fields: [playerId], references: [id])

  teamId String? @map("team_id") // Para saber a qué equipo pertenece el evento

  // Para cambios de jugador
  playerOutId String? @map("player_out_id")

  @@index([matchId, minute])
  @@map("match_events")
}

enum EventType {
  GOAL
  YELLOW_CARD
  RED_CARD
  SUBSTITUTION
  KICK_OFF
  HALF_TIME
  SECOND_HALF_START
  FULL_TIME
  OWN_GOAL
}

// MODELO DE TABLA DE POSICIONES
model Standing {
  id             String @id @default(uuid())

  played         Int    @default(0)
  won            Int    @default(0)
  drawn          Int    @default(0)
  lost           Int    @default(0)
  goalsFor       Int    @default(0) @map("goals_for")
  goalsAgainst   Int    @default(0) @map("goals_against")
  goalDifference Int    @default(0) @map("goal_difference")
  points         Int    @default(0)

  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relaciones
  championshipId String       @map("championship_id")
  championship   Championship @relation(fields: [championshipId], references: [id], onDelete: Cascade)

  teamId String @map("team_id")
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([championshipId, teamId])
  @@index([championshipId, points])
  @@map("standings")
}
